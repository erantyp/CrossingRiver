<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê°•ê±´ë„ˆê¸° v1.0 (ê¸°ì¤€ ìŠ¤ëƒ…ìƒ·)</title>
  <style>
    :root {
      --bg1: #1b2735;
      --bg2: #090a0f;
      --river: #3aa6d0;
      --bank: #e9efe6;
      --ink: #101318;
      --accent: #6fe4ff;
      --boat: #ffe08a;
      --shadow: rgba(0,0,0,.25);
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      color: var(--ink);
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      overflow: hidden;
    }
    .wrap {
      position: relative;
      height: 100%;
      display: grid;
      grid-template-columns: 1fr min(54vmin, 680px) 1fr;
      grid-template-rows: 80px 1fr 120px;
      gap: 0;
      align-items: stretch;
      justify-items: stretch;
    }
    header {
      grid-column: 1/4;
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 16px; color: white;
    }
    header .title { font-weight: 700; letter-spacing: .5px; }
    header .meta { font-size: 14px; opacity: .9; }

    /* River vertical strip through center column */
    .riverCol { grid-column: 2; grid-row: 1/4; position: relative; z-index: 0; }
    .river {
      position: absolute; inset: 0 35%;
      background: linear-gradient(0deg, #2b9ecb, #5bc8f0);
      box-shadow: inset 0 0 40px rgba(0,0,0,.35);
      border-left: 6px solid rgba(255,255,255,.25);
      border-right: 6px solid rgba(0,0,0,.15);
      z-index: 0;
      pointer-events: none;
    }

    /* Banks (left/right) */
    .bank {
      display: grid;
      place-items: center;
      padding: 12px 8px;
    }
    .bank.left { grid-column: 1; grid-row: 2; }
    .bank.right { grid-column: 3; grid-row: 2; }
    .bank .pad {
      width: 92%; height: 92%;
      background: var(--bank);
      border-radius: 20px;
      box-shadow: 0 10px 30px var(--shadow), inset 0 2px 0 rgba(255,255,255,.6);
      display: grid; grid-auto-rows: minmax(44px, auto);
      align-content: start;
      gap: 8px; padding: 12px;
      position: relative; z-index: 2;
    }
    .dockLabel {
      text-align: center; font-weight: 700; color: #445; margin-bottom: 6px;
    }

    /* Boat */
    .boat {
      position: absolute;
      left: 50%; transform: translateX(-50%);
      bottom: 18%;
      width: min(40vmin, 480px);
      height: min(14vmin, 160px);
      border-radius: 24px;
      background: var(--boat);
      box-shadow: 0 10px 30px var(--shadow), inset 0 -10px 0 rgba(0,0,0,.08);
      display: grid; grid-template-rows: 32px 1fr;
      cursor: grab;
      z-index: 3;
    }
    .boat.dragging { opacity: .9; cursor: grabbing; scale: 1.02; }
    .sail {
      height: 32px; display: flex; align-items: center; justify-content: center;
      font-size: 20px; filter: drop-shadow(0 2px 0 rgba(0,0,0,.12));
    }
    .hold {
      display: grid; grid-auto-flow: column; grid-auto-columns: 1fr;
      align-items: center; justify-items: center; padding: 6px;
      gap: 6px;
    }

    /* Tokens */
    .token {
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 28px; line-height: 1; padding: 8px 10px; gap: 6px;
      background: white; border-radius: 14px; box-shadow: 0 4px 12px var(--shadow);
      user-select: none; -webkit-user-drag: none;
      border: 2px solid rgba(0,0,0,.08);
    }
    .token.small { font-size: 22px; transform: translateY(1px); }
    .token .lbl { font-size: 12px; color: #445; font-weight: 700; }

    .row { display: grid; grid-auto-flow: column; gap: 8px; align-items: center; }

    .hud {
      grid-column: 1/4; grid-row: 3;
      display: grid; grid-template-columns: 1fr max-content 1fr; align-items: center;
      color: #dff7ff; padding: 10px 16px 22px;
      position: relative; z-index: 5;
    }
    .hud .status { font-weight: 700; }
    .hud .controls { display: flex; gap: 8px; }
    button { border: 0; background: #00bcd4; color: #042028; padding: 10px 14px; border-radius: 12px; font-weight: 800; box-shadow: 0 8px 16px rgba(0,0,0,.2); }
    button.secondary { background: #79e2f2; }
    button.ghost { background: transparent; color: #dff7ff; border: 2px solid rgba(255,255,255,.4); }

    .toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 16px; background: rgba(0,0,0,.8); color: white; padding: 10px 12px; border-radius: 10px; display: none; }
    .toast.show { display: inline-block; }

    .stageTag { color: #bff2ff; font-weight: 800; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">ê°•ê±´ë„ˆê¸° v1.0 <span class="stageTag" id="stageTag"></span></div>
      <div class="meta" id="meta">ë“œë˜ê·¸ë¡œ ë°° ì´ë™(ë‘‘â†”ë‘‘) â€¢ ì¹˜íŠ¸í‚¤: ` ë˜ëŠ” â‚© + Enter</div>
    </header>

    <div class="riverCol">
      <div class="river"></div>
      <div class="boat" id="boat" draggable="true" aria-label="boat">
        <div class="sail">â›µï¸</div>
        <div class="hold" id="boatHold"></div>
      </div>
    </div>

    <div class="bank left">
      <div class="pad">
        <div class="dockLabel">ì™¼ìª½ ë‘‘</div>
        <div id="leftRows"></div>
      </div>
    </div>
    <div class="bank right">
      <div class="pad">
        <div class="dockLabel">ì˜¤ë¥¸ìª½ ë‘‘</div>
        <div id="rightRows"></div>
      </div>
    </div>

    <div class="hud">
      <div class="status" id="status">ì¤€ë¹„ ì™„ë£Œ</div>
      <div class="controls">
        <button class="ghost" id="btnReset">Reset</button>
        <button class="secondary" id="btnLoad">Stage ì¬ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button id="btnMove">ìŠ¹ê° ì´ë™(ë‘‘â‡„ë°°)</button>
      </div>
      <div style="text-align:right; font-size:14px; opacity:.9">Boat capacity: <b id="capView">-</b></div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <script>
    /*************************
     * v1.0 ê¸°ì¤€ ìŠ¤ëƒ…ìƒ· ì„¤ì • *
     *************************/
    // ìŠ¤í…Œì´ì§€ êµ¬ì„± ìš”ì•½ (ë©”ëª¨ ê¸°ì¤€)
    // - Stage5: ë°° ìš©ëŸ‰ 4
    // - ì¹˜íŠ¸í‚¤: ` ë˜ëŠ” â‚© + Enter â†’ ê°•ì œ ì„±ê³µ
    // - ë“œë˜ê·¸ë¡œ ë°°ë¥¼ ë‘‘â†”ë‘‘ ì´ë™(ë°° ìœ„ì¹˜ë§Œ ë“œë˜ê·¸)
    // - ì´ëª¨ì§€ ë§¤í•‘: A=ğŸ‘¾, B=ğŸ‘½, ì„ êµì‚¬=ğŸ§‘â€ğŸ¦³, ì¥=ğŸ­ (mouse vs M* ì¶©ëŒ ê°€ëŠ¥ì„± ë©”ëª¨)
    // - Stage3: ì—˜í”„/ì¢€ë¹„/ë§ˆë²•ì‚¬ (ë‘ëª©/ë¶€í•˜ í¬ê¸° ì°¨ì´) â†’ í¬ê¸° í‘œì‹œëŠ” small í´ë˜ìŠ¤ë¡œ ëŒ€ëµ ë°˜ì˜
    // - Stage5: ì½”ë¼ë¦¬/í˜¸ë‘ì´ ê·œì¹™ì€ "ë°° ì•ˆì—ì„œë§Œ" ì¶©ëŒ ì²´í¬

    const STAGES = [
      {
        id: 1,
        title: "Stage 1 â€” Wolf, Sheep & Cabbage",
        boatCap: 2,
        tokens: [
          t("Farmer", "ğŸ‘¨â€ğŸŒ¾"),
          t("Wolf", "ğŸº"),
          t("Sheep", "ğŸ‘"),
          t("Cabbage", "ğŸ¥¬")
        ],
        rule({left, right, boat, where}){
          // ì‹¤íŒ¨ ì¡°ê±´: Farmer ì—†ëŠ” ê³³ì—ì„œ Wolf+Sheep ë‹¨ë‘˜ or Sheep+Cabbage ë‹¨ë‘˜
          const checkSide = (arr)=>{
            const has = (name) => arr.some(x=>x.name===name);
            const count = (name) => arr.filter(x=>x.name===name).length;
            const noFarmer = !has("Farmer");
            if(noFarmer){
              if(has("Wolf") && has("Sheep") && count("Wolf")+count("Sheep")===arr.length) return "ëŠ‘ëŒ€ê°€ ì–‘ì„ ë¨¹ì—ˆì–´ìš”!";
              if(has("Sheep") && has("Cabbage") && count("Sheep")+count("Cabbage")===arr.length) return "ì–‘ì´ ì–‘ë°°ì¶”ë¥¼ ë¨¹ì—ˆì–´ìš”!";
            }
            return null;
          }
          return checkSide(left) || checkSide(right) || null;
        },
      },
      {
        id: 2,
        title: "Stage 2 â€” Missionaries & Vampires",
        boatCap: 2,
        tokens: [
          t("Missionary", "ğŸ§‘â€ğŸ¦³"), t("Missionary", "ğŸ§‘â€ğŸ¦³"), t("Missionary", "ğŸ§‘â€ğŸ¦³"),
          t("Vampire", "ğŸ§›"), t("Vampire", "ğŸ§›"), t("Vampire", "ğŸ§›")
        ],
        rule({left, right}){
          // ì–´ëŠ ìª½ì´ë“  Missionary > 0 ì¼ ë•Œ Vampires > Missionaries ì´ë©´ ì‹¤íŒ¨
          const bad = (arr) => {
            const m = arr.filter(x=>x.name==="Missionary").length;
            const v = arr.filter(x=>x.name==="Vampire").length;
            return m>0 && v>m ? "ì„ êµì‚¬ê°€ ë±€íŒŒì´ì–´ì—ê²Œ ë°€ë ¤ìš”!" : null;
          }
          return bad(left) || bad(right) || null;
        },
      },
      {
        id: 3,
        title: "Stage 3 â€” Elf, Zombie & Wizard (Boss/Minion)",
        boatCap: 2,
        tokens: [
          t("Elf", "ğŸ§"),
          t("Zombie", "ğŸ§Ÿ"), t("Zombie-minion", "ğŸ§Ÿ", true),
          t("Wizard", "ğŸ§™"), t("Wizard-minion", "ğŸ§™", true)
        ],
        rule(){
          // v1.0: íŠ¹ë³„í•œ ê¸ˆê¸° ê·œì¹™ ì—†ìŒ (í›„ì† ë²„ì „ì—ì„œ ë³´ìŠ¤/ë¶€í•˜ ì°¨ë“± ê·œì¹™ í™•ì¥ ì˜ˆì •)
          return null;
        },
      },
      {
        id: 4,
        title: "Stage 4 â€” Alien caretakers & Lions",
        boatCap: 3,
        tokens: [
          t("A", "ğŸ‘¾"), t("B", "ğŸ‘½"),
          t("Lion", "ğŸ¦"), t("Lion-cub", "ğŸ¦", true)
        ],
        rule(){
          // v1.0: ì¶©ëŒ ê·œì¹™ ì—†ìŒ (í›„ì†ì—ì„œ ì‚¬ìœ¡ì‚¬/ì‚¬ì ì„¸ë¶€ ê·œì¹™ ë³€ê²½ ì˜ˆì •)
          return null;
        },
      },
      {
        id: 5,
        title: "Stage 5 â€” Trainer & Animals (Elephant/Tiger rule in boat only)",
        boatCap: 4, // ì¤‘ìš”: v1.0 ëª…ì„¸
        tokens: [
          t("Trainer", "ğŸ§‘â€ğŸ«"),
          t("Elephant", "ğŸ˜"),
          t("Tiger", "ğŸ…"),
          t("Mouse", "ğŸ­")
        ],
        rule({boat}){
          // ì½”ë¼ë¦¬/í˜¸ë‘ì´ ê·œì¹™ì€ "ë°° ì•ˆì—ì„œë§Œ" ì²´í¬
          const has = (name)=> boat.some(x=>x.name===name);
          if(has("Elephant") && has("Tiger") && !has("Trainer")){
            return "ë°° ì•ˆì—ì„œ ì½”ë¼ë¦¬ì™€ í˜¸ë‘ì´ëŠ” ì¡°ë ¨ì‚¬ ì—†ì´ íƒˆ ìˆ˜ ì—†ì–´ìš”!";
          }
          return null;
        },
      },
    ];

    function t(name, emoji, small=false){
      return { id: uid(), name, emoji, small };
    }

    // --- State ---
    let state = {
      stageIdx: 0,
      where: new Map(), // tokenId -> 'left' | 'right' | 'boat'
      boatSide: 'left',
    };

    const el = (sel)=>document.querySelector(sel);
    const leftRows = el('#leftRows');
    const rightRows = el('#rightRows');
    const boatHold = el('#boatHold');
    const boat = el('#boat');
    const status = el('#status');
    const stageTag = el('#stageTag');
    const capView = el('#capView');

    // --- Init ---
    loadStage(0);
    bindUI();
    // allow HTML5 drag to fire consistently
    document.addEventListener('dragover', (e)=> e.preventDefault());
    document.addEventListener('drop', (e)=> e.preventDefault());

    function loadStage(idx){
      state.stageIdx = idx;
      const stage = STAGES[idx];
      state.where = new Map();
      state.boatSide = 'left';
      stage.tokens.forEach(tok=>state.where.set(tok.id, 'left'));
      render();
      toast(`Loaded: ${stage.title}`);
    }

    function render(){
      const stage = STAGES[state.stageIdx];
      stageTag.textContent = `Â· ${stage.title}`;
      capView.textContent = stage.boatCap;

      leftRows.innerHTML = '';
      rightRows.innerHTML = '';
      boatHold.innerHTML = '';

      // Pack tokens by location
      const loc = { left: [], right: [], boat: [] };
      stage.tokens.forEach(tok=>{
        loc[state.where.get(tok.id)].push(tok);
      });

      const makeRow = (arr, container)=>{
        const row = document.createElement('div');
        row.className = 'row';
        arr.forEach(tok=>row.appendChild(renderToken(tok)));
        container.appendChild(row);
      };

      if(loc.left.length) makeRow(loc.left, leftRows);
      if(loc.right.length) makeRow(loc.right, rightRows);
      if(loc.boat.length) makeRow(loc.boat, boatHold);

      // Position boat to side
      const river = document.querySelector('.riverCol');
      const rect = river.getBoundingClientRect();
      const leftX = rect.left + rect.width*0.25;
      const rightX = rect.left + rect.width*0.75;
      const x = state.boatSide==='left' ? leftX : rightX;
      boat.style.left = `${x - rect.left}px`;

      updateStatus();
    }

    function renderToken(tok){
      const d = document.createElement('div');
      d.className = 'token' + (tok.small? ' small':'');
      d.dataset.id = tok.id;
      d.title = tok.name;
      d.innerHTML = `<span class="e">${tok.emoji}</span> <span class="lbl">${tok.name}</span>`;
      d.addEventListener('click', ()=>onTokenClick(tok));
      return d;
    }

    function onTokenClick(tok){
      // ìŠ¹ê° ì´ë™: í˜„ì¬ ë°°ê°€ ìˆëŠ” ë‘‘ì— ìˆëŠ” ìŠ¹ê°ë§Œ ë°°ë¡œ, ë°° ìŠ¹ê°ì€ í•´ë‹¹ ë‘‘ìœ¼ë¡œ
      const stage = STAGES[state.stageIdx];
      const loc = state.where.get(tok.id);
      if(loc==='boat'){
        // ë‚´ë¦¬ê¸° â†’ ë°°ê°€ ìˆëŠ” ë‘‘ìœ¼ë¡œ
        state.where.set(tok.id, state.boatSide);
      } else if(loc===state.boatSide){
        // íƒ€ê¸°
        const boatNow = tokensIn('boat').length;
        if(boatNow < stage.boatCap){
          state.where.set(tok.id, 'boat');
        } else {
          toast('ë°°ê°€ ê°€ë“ ì°¼ì–´ìš”');
        }
      } else {
        toast('ë°°ê°€ ìˆëŠ” ìª½ì—ì„œë§Œ ìŠ¹ì„  ê°€ëŠ¥');
      }
      render();
    }

    function tokensIn(side){
      const stage = STAGES[state.stageIdx];
      return stage.tokens.filter(t=>state.where.get(t.id)===side);
    }

    function updateStatus(msg){
      if(msg){ status.textContent = msg; return; }
      const stage = STAGES[state.stageIdx];
      const allRight = stage.tokens.every(tok=>state.where.get(tok.id)==='right');
      if(allRight){
        status.textContent = `ğŸ‰ Stage ${stage.id} Clear!`;
      } else {
        status.textContent = `Boat on ${state.boatSide.toUpperCase()} â€” ìŠ¹ê°ì„ íƒœìš°ê³  ë°°ë¥¼ ì˜®ê²¨ ë³´ì„¸ìš”`;
      }
    }

    function trySail(){
      // ë°° ì´ë™(ë‘‘â†”ë‘‘) ì‹œ ê·œì¹™ ê²€ì‚¬
      const stage = STAGES[state.stageIdx];
      // ìµœì†Œ 1ëª… íƒ‘ìŠ¹ í•„ìš” ì¡°ê±´ì€ v1.0ì—ì„œ ììœ  (ì›í•œë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ)
      // if(tokensIn('boat').length===0){ toast('ë¹ˆ ë°°ëŠ” ì´ë™ ë¶ˆê°€'); return; }

      // ì´ë™
      state.boatSide = state.boatSide==='left' ? 'right' : 'left';

      // í•˜ì„  ì—†ì´ ë‘‘ ê·œì¹™/ë³´íŠ¸ ê·œì¹™ ì²´í¬
      const err = (stage.rule||(()=>null))({
        left: tokensIn('left'),
        right: tokensIn('right'),
        boat: tokensIn('boat'),
        where: state.where
      });
      if(err){
        // ë¡¤ë°±
        state.boatSide = state.boatSide==='left' ? 'right' : 'left';
        toast(err);
        render();
        return;
      }
      render();

      // í´ë¦¬ì–´ ì²´í¬
      const allRight = stage.tokens.every(tok=>state.where.get(tok.id)==='right');
      if(allRight){
        toast(`Stage ${stage.id} ì„±ê³µ!`);
        // ë‹¤ìŒ ìŠ¤í…Œì´ì§€ ìë™ ë¡œë“œ (v1.0 ìœ ì§€)
        if(state.stageIdx < STAGES.length-1){
          setTimeout(()=>loadStage(state.stageIdx+1), 650);
        } else {
          // v1.0: ìµœì¢… ì„±ê³µí™”ë©´ ì§‘ê³„ëŠ” ì´í›„ ë²„ì „ ì˜ˆì •
          setTimeout(()=>toast('ëª¨ë“  ìŠ¤í…Œì´ì§€ ì™„ë£Œ! (v1.0)'), 800);
        }
      }
    }

    function bindUI(){
      el('#btnReset').addEventListener('click', ()=>loadStage(state.stageIdx));
      el('#btnLoad').addEventListener('click', ()=>loadStage(state.stageIdx));
      el('#btnMove').addEventListener('click', trySail);

      // Boat drag (ë‘‘â†”ë‘‘)
      let drag = { active:false, sx:0, ox:0 };
      boat.addEventListener('dragstart', (e)=>{
        drag.active = true; boat.classList.add('dragging');
        drag.sx = e.clientX; drag.ox = boat.offsetLeft;
        if(e.dataTransfer){ e.dataTransfer.effectAllowed = 'move'; }
        // firefox ë“œë˜ê·¸ ë¯¸ë¦¬ë³´ê¸° ë°©ì§€
        const img = new Image(); img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>';
        e.dataTransfer && e.dataTransfer.setDragImage(img, 0, 0);
      });
        drag.sx = e.clientX; drag.ox = boat.offsetLeft;
        // firefox ë“œë˜ê·¸ ë¯¸ë¦¬ë³´ê¸° ë°©ì§€
        const img = new Image(); img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>';
        e.dataTransfer.setDragImage(img, 0, 0);
      });
      boat.addEventListener('dragend', (e)=>{
        boat.classList.remove('dragging');
        drag.active=false;
        // ì¤‘ì•™ ê¸°ì¤€ ì¢Œ/ìš°ë¡œ ìŠ¤ëƒ… â†’ ì´ë™ ì‹œë„
        const river = document.querySelector('.riverCol');
        const rect = river.getBoundingClientRect();
        const mid = rect.width/2;
        const x = e.clientX - rect.left;
        const target = (x < mid) ? 'left' : 'right';
        const changed = (target!==state.boatSide);
        if(changed){
          trySail();
        } else {
          render();
        }
      });

      // í‚¤ë³´ë“œ ì¹˜íŠ¸í‚¤: ` ë˜ëŠ” â‚© + Enter
      let backtickArmed = false;
      window.addEventListener('keydown', (e)=>{
        if(e.key==='`' || e.key==='~' || e.code==='Backquote' || e.key==='â‚©'){
          backtickArmed = true;
        } else if(backtickArmed && (e.key==='Enter')){
          backtickArmed = false;
          forceClear();
        } else {
          backtickArmed = false;
        }
      });

      // ë”ë¸”í´ë¦­ìœ¼ë¡œë„ ë°° ì´ë™(ë“œë˜ê·¸ ì•ˆë  ë•Œ ëŒ€ë¹„)
      boat.addEventListener('dblclick', ()=> trySail());
    }

    function forceClear(){
      const stage = STAGES[state.stageIdx];
      stage.tokens.forEach(tok=>state.where.set(tok.id, 'right'));
      render();
      toast(`ì¹˜íŠ¸í‚¤ë¡œ Stage ${stage.id} í´ë¦¬ì–´ ì²˜ë¦¬ë¨`);
      if(state.stageIdx < STAGES.length-1){
        setTimeout(()=>loadStage(state.stageIdx+1), 500);
      } else {
        setTimeout(()=>toast('ëª¨ë“  ìŠ¤í…Œì´ì§€ ì™„ë£Œ! (v1.0, ì¢…í•©ê¸°ë¡ì€ ì°¨ê¸°ë²„ì „)'), 700);
      }
    }

    function uid(){ return Math.random().toString(36).slice(2,9); }

    function toast(msg){
      const t = el('#toast');
      t.textContent = msg; t.classList.add('show');
      clearTimeout(toast._to);
      toast._to = setTimeout(()=>t.classList.remove('show'), 1600);
    }
  </script>
</body>
</html>
