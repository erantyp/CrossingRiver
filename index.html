<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Í∞ïÍ±¥ÎÑàÍ∏∞ v1.0-light</title>
  <style>
    :root {
      --bg1:#eff5ff; --ink:#0b1020; --accent:#2d7df6;
      --river:#9edbff; --bank:#ffffff; --boat:#ffe08a; --muted:#6b7a90;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; color:var(--ink); background:linear-gradient(180deg,#f7fbff,#eaf3ff 60%, #e3f5ff); }

    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .title { font-weight:800; font-size:20px; }
    .hint { color:var(--muted); font-size:14px; }

    .board { display:grid; grid-template-columns: 1fr 200px 1fr; gap:12px; margin-top:12px; align-items:stretch; }
    .bank { background:var(--bank); border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.08); padding:12px; }
    .bank h3 { margin:0 0 8px; font-size:14px; color:#3a4862; }

    .river { background:var(--river); border-radius:16px; box-shadow:inset 0 0 20px rgba(0,0,0,.12); display:flex; flex-direction:column; align-items:center; justify-content:space-between; padding:12px; }
    .boat { margin: 8px 0; width: 100%; min-height: 88px; background:var(--boat); border-radius:16px; display:flex; align-items:center; justify-content:center; gap:8px; box-shadow:0 8px 20px rgba(0,0,0,.15) inset; font-weight:700; }
    .boat .cap { font-size:12px; color:#5a4b19; }

    .row { display:flex; flex-wrap:wrap; gap:8px; }
    .token { display:inline-flex; align-items:center; gap:6px; padding:8px 10px; background:#fff; border:2px solid #e8eef9; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,.06); cursor:pointer; }
    .token.small { font-size:14px; }
    .token .e { font-size:22px; line-height:1; }
    .token .lbl { font-size:12px; font-weight:800; color:#3b4a6a; }

    .hud { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:12px; }
    .left { text-align:left; }
    .right { text-align:right; }

    button { border:0; background:var(--accent); color:#fff; padding:10px 12px; border-radius:10px; font-weight:800; box-shadow:0 6px 16px rgba(45,125,246,.3); }
    button.ghost { background:transparent; color:#2d7df6; border:2px solid #bcd3ff; box-shadow:none; }

    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:16px; background:#111b; color:#fff; padding:8px 10px; border-radius:10px; display:none; }
    .toast.show { display:block; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Í∞ïÍ±¥ÎÑàÍ∏∞ v1.0-light <span id="stageTag" style="color:#2d7df6"></span></div>
      <div class="hint">ÌÅ¥Î¶≠ÏúºÎ°ú ÌÉëÏäπ/ÌïòÏÑ† ‚Ä¢ MoveÎ°ú Î∞∞ Ïù¥Îèô ‚Ä¢ ÏπòÌä∏ÌÇ§: ` ÎòêÎäî ‚Ç© + Enter (ÎòêÎäî Î∞±Ìã± 2Î≤à)</div>
    </header>

    <div class="board">
      <div class="bank">
        <h3>ÏôºÏ™Ω Îëë</h3>
        <div id="leftRows" class="row"></div>
      </div>
      <div class="river">
        <div style="font-size:20px">‚õµÔ∏è</div>
        <div class="boat">
          <div id="boatHold" class="row"></div>
        </div>
        <div class="cap">Boat capacity: <b id="capView">-</b></div>
      </div>
      <div class="bank">
        <h3>Ïò§Î•∏Ï™Ω Îëë</h3>
        <div id="rightRows" class="row"></div>
      </div>
    </div>

    <div class="hud">
      <div id="status" class="left">Ready</div>
      <div class="right">
        <button class="ghost" id="btnReset">Reset</button>
        <button class="ghost" id="btnLoad">Reload Stage</button>
        <button id="btnMove">Move (Îëë‚áÑÎëë)</button>
        <button class="ghost" id="btnCheat">Cheat</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ---------- Data ----------
    const STAGES = [
      { id:1, title:"1Îã®Í≥Ñ ‚Äî ÎäëÎåÄ, Ïñë, ÏñëÎ∞∞Ï∂î", boatCap:2,
        tokens:[ t('Farmer','üë®‚Äçüåæ'), t('Wolf','üê∫'), t('Sheep','üêë'), t('Cabbage','ü•¨') ],
        rule({left,right}){
          const bad=(arr)=>{const H=n=>arr.some(x=>x.name===n); const C=n=>arr.filter(x=>x.name===n).length; const noFarmer=!H('Farmer'); if(!noFarmer) return null; if(H('Wolf')&&H('Sheep')&&C('Wolf')+C('Sheep')===arr.length) return 'ÎäëÎåÄÍ∞Ä ÏñëÏùÑ Î®πÏóàÏñ¥Ïöî!'; if(H('Sheep')&&H('Cabbage')&&C('Sheep')+C('Cabbage')===arr.length) return 'ÏñëÏù¥ ÏñëÎ∞∞Ï∂îÎ•º Î®πÏóàÏñ¥Ïöî!'; return null; };
          return bad(left)||bad(right)||null; }
      },
      { id:2, title:"2Îã®Í≥Ñ ‚Äî ÏÑ†ÍµêÏÇ¨ÏôÄ Î±ÄÌååÏù¥Ïñ¥", boatCap:2,
        tokens:[ t('Missionary','üßë‚Äçü¶≥'),t('Missionary','üßë‚Äçü¶≥'),t('Missionary','üßë‚Äçü¶≥'), t('Vampire','üßõ'),t('Vampire','üßõ'),t('Vampire','üßõ') ],
        rule({left,right}){ const bad=(arr)=>{const m=arr.filter(x=>x.name==='Missionary').length; const v=arr.filter(x=>x.name==='Vampire').length; return m>0 && v>m ? 'ÏÑ†ÍµêÏÇ¨Í∞Ä Î±ÄÌååÏù¥Ïñ¥ÏóêÍ≤å Î∞ÄÎ†§Ïöî!' : null;}; return bad(left)||bad(right)||null; }
      },
      { id:3, title:"3Îã®Í≥Ñ ‚Äî ÏóòÌîÑ/Ï¢ÄÎπÑ/ÎßàÎ≤ïÏÇ¨", boatCap:2,
        tokens:[ t('Elf','üßù'), t('Zombie','üßü'), t('Zombie-minion','üßü',true), t('Wizard','üßô'), t('Wizard-minion','üßô',true) ],
        rule(){ return null; }
      },
      { id:4, title:"4Îã®Í≥Ñ ‚Äî Ïô∏Í≥ÑÏù∏! ÏÇ¨Ïú°ÏÇ¨ÏôÄ ÏÇ¨Ïûê", boatCap:3,
        tokens:[ t('A','üëæ'), t('B','üëΩ'), t('Lion','ü¶Å'), t('Lion-cub','ü¶Å',true) ],
        rule(){ return null; }
      },
      { id:5, title:"5Îã®Í≥Ñ ‚Äî Ï°∞Î†®ÏÇ¨ÏôÄ ÎèôÎ¨ºÎì§", boatCap:4,
        tokens:[ t('Trainer','üßë‚Äçüè´'), t('Elephant','üêò'), t('Tiger','üêÖ'), t('Mouse','üê≠') ],
        rule({boat}){ const H=n=>boat.some(x=>x.name===n); if(H('Elephant')&&H('Tiger')&&!H('Trainer')) return 'Î∞∞ ÏïàÏóêÏÑú ÏΩîÎÅºÎ¶¨ÏôÄ Ìò∏ÎûëÏù¥Îäî Ï°∞Î†®ÏÇ¨ ÏóÜÏù¥ ÌÉà Ïàò ÏóÜÏñ¥Ïöî!'; return null; }
      }
    ];

    function t(name,emoji,small=false){ return { id:uid(), name, emoji, small }; }

    // ---------- State & Elements ----------
    const $ = s=>document.querySelector(s);
    const leftRows = $('#leftRows');
    const rightRows = $('#rightRows');
    const boatHold = $('#boatHold');
    const status = $('#status');
    const stageTag = $('#stageTag');
    const capView = $('#capView');
    const toastEl = $('#toast');

    let state = { stageIdx:0, where:new Map(), boatSide:'left' };

    // ---------- Init ----------
    init();
    function init(){ loadStage(0); bindUI(); }

    function loadStage(idx){
      state.stageIdx = idx; state.where = new Map(); state.boatSide='left';
      const s = STAGES[idx];
      s.tokens.forEach(tok=> state.where.set(tok.id,'left'));
      render(); toast(`Loaded: ${s.title}`);
    }

    function bindUI(){
      $('#btnReset').addEventListener('click', ()=> loadStage(state.stageIdx));
      $('#btnLoad').addEventListener('click', ()=> loadStage(state.stageIdx));
      $('#btnMove').addEventListener('click', trySail);
      $('#btnCheat').addEventListener('click', forceClear);

      // Robust cheat: backquote immediately + Enter, or double-backquote within 700ms, or with modifiers
      let armed=false, last=0;
      window.addEventListener('keydown', (e)=>{
        const isBack = (e.key==='`'||e.key==='~'||e.code==='Backquote'||e.key==='‚Ç©');
        if(isBack && (e.ctrlKey||e.metaKey||e.altKey||e.shiftKey)) return void forceClear();
        if(isBack){ const now=Date.now(); if(now-last<700) return void forceClear(); armed=true; last=now; return; }
        if(armed && e.key==='Enter'){ armed=false; return void forceClear(); }
        armed=false;
      });
    }

    // ---------- Render & Helpers ----------
    function render(){
      const s = STAGES[state.stageIdx];
      stageTag.textContent = `¬∑ ${s.title}`; capView.textContent = s.boatCap;
      leftRows.innerHTML=''; rightRows.innerHTML=''; boatHold.innerHTML='';

      const loc={left:[], right:[], boat:[]};
      s.tokens.forEach(tok=>{ const w=state.where.get(tok.id)||'left'; state.where.set(tok.id,w); loc[w].push(tok); });
      if(loc.left.length) leftRows.appendChild(makeRow(loc.left));
      if(loc.right.length) rightRows.appendChild(makeRow(loc.right));
      if(loc.boat.length) boatHold.appendChild(makeRow(loc.boat));
      updateStatus();
    }

    function makeRow(arr){ const row=document.createElement('div'); row.className='row'; arr.forEach(tok=> row.appendChild(renderToken(tok))); return row; }

    function renderToken(tok){
      const d=document.createElement('div'); d.className='token'+(tok.small?' small':''); d.dataset.id=tok.id; d.title=tok.name;
      d.innerHTML=`<span class="e">${tok.emoji}</span><span class="lbl">${tok.name}</span>`;
      d.addEventListener('click', ()=> onTokenClick(tok));
      return d;
    }

    function onTokenClick(tok){
      const s=STAGES[state.stageIdx]; const loc=state.where.get(tok.id);
      if(loc==='boat'){ state.where.set(tok.id, state.boatSide); }
      else if(loc===state.boatSide){ if(tokensIn('boat').length < s.boatCap) state.where.set(tok.id,'boat'); else toast('Î∞∞Í∞Ä Í∞ÄÎìù Ï∞ºÏñ¥Ïöî'); }
      else { toast('Î∞∞Í∞Ä ÏûàÎäî Ï™ΩÏóêÏÑúÎßå ÏäπÏÑ† Í∞ÄÎä•'); }
      render();
    }

    function tokensIn(side){ const s=STAGES[state.stageIdx]; return s.tokens.filter(t=> state.where.get(t.id)===side); }

    function trySail(){
      const s=STAGES[state.stageIdx];
      // toggle side
      state.boatSide = (state.boatSide==='left') ? 'right' : 'left';
      const err = (s.rule||(()=>null))({ left:tokensIn('left'), right:tokensIn('right'), boat:tokensIn('boat'), where:state.where });
      if(err){ state.boatSide = (state.boatSide==='left') ? 'right' : 'left'; toast(err); return render(); }
      render();
      // clear check
      const allRight = s.tokens.every(tok=> state.where.get(tok.id)==='right');
      if(allRight){ toast(`Stage ${s.id} ÏÑ±Í≥µ!`); if(state.stageIdx<STAGES.length-1){ setTimeout(()=>loadStage(state.stageIdx+1),600); } else { setTimeout(()=>toast('Î™®Îì† Ïä§ÌÖåÏù¥ÏßÄ ÏôÑÎ£å! v1.0-light'), 800); } }
    }

    function updateStatus(){ const s=STAGES[state.stageIdx]; const allRight = s.tokens.every(tok=> state.where.get(tok.id)==='right'); status.textContent = allRight ? `üéâ Stage ${s.id} Clear` : `Boat on ${state.boatSide.toUpperCase()} ‚Äî click tokens, then Move`; }

    function forceClear(){ const s=STAGES[state.stageIdx]; s.tokens.forEach(tok=> state.where.set(tok.id,'right')); render(); toast(`ÏπòÌä∏Î°ú Stage ${s.id} ÌÅ¥Î¶¨Ïñ¥`); if(state.stageIdx<STAGES.length-1){ setTimeout(()=>loadStage(state.stageIdx+1),500);} else { setTimeout(()=>toast('Î™®Îì† Ïä§ÌÖåÏù¥ÏßÄ ÏôÑÎ£å! v1.0-light'),700);} }

    function uid(){ return Math.random().toString(36).slice(2,9); }
    function toast(m){ toastEl.textContent=m; toastEl.classList.add('show'); clearTimeout(toast._t); toast._t=setTimeout(()=>toastEl.classList.remove('show'),1500); }
  </script>
</body>
</html>
